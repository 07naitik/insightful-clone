"use strict";var _=Object.create;var I=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var C=(r,o,i,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of E(o))!$.call(r,s)&&s!==i&&I(r,s,{get:()=>o[s],enumerable:!(e=P(o,s))||e.enumerable});return r};var x=(r,o,i)=>(i=r!=null?_(F(r)):{},C(o||!r||!r.__esModule?I(i,"default",{value:r,enumerable:!0}):i,r));const n=require("electron"),w=require("path"),z=require("keytar"),D=require("macaddress"),T=require("os"),A=require("fs");function g(r){const o=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const i in r)if(i!=="default"){const e=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(o,i,e.get?e:{enumerable:!0,get:()=>r[i]})}}return o.default=r,Object.freeze(o)}const f=g(z),M=g(D),k=g(T),m=g(A),N=process.env.NODE_ENV==="development",y="insightful-time-tracker",S="auth-token",p=w.join(k.homedir(),".insightful-token");class O{constructor(){this.mainWindow=null,this.screenshotInterval=null}async createWindow(){this.mainWindow=new n.BrowserWindow({width:1e3,height:700,minWidth:800,minHeight:600,show:!1,titleBarStyle:"default",frame:!0,transparent:!1,resizable:!0,maximizable:!0,minimizable:!0,closable:!0,title:"Insightful Time Tracker",icon:w.join(__dirname,"../public/icon.png"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:w.join(__dirname,"preload.js"),webSecurity:!0,allowRunningInsecureContent:!1,experimentalFeatures:!1}}),N?(await this.mainWindow.loadURL("http://localhost:5173"),this.mainWindow.webContents.openDevTools()):await this.mainWindow.loadFile(w.join(__dirname,"../dist/index.html")),this.mainWindow.show(),console.log("✅ Window should now be visible"),this.mainWindow.once("ready-to-show",()=>{var o;console.log("✅ Ready-to-show event fired"),(o=this.mainWindow)==null||o.show()}),this.mainWindow.on("closed",()=>{this.mainWindow=null,this.screenshotInterval&&clearInterval(this.screenshotInterval)})}setupIPC(){n.ipcMain.handle("auth:store-token",async(e,s)=>{try{return await f.setPassword(y,S,s),{success:!0}}catch{try{return m.writeFileSync(p,s,"utf8"),{success:!0}}catch{return{success:!1,error:"Failed to store token securely"}}}}),n.ipcMain.handle("auth:get-token",async()=>{try{const e=await f.getPassword(y,S);return e?{success:!0,token:e}:{success:!1,error:"No token found"}}catch{try{return m.existsSync(p)?{success:!0,token:m.readFileSync(p,"utf8")}:{success:!1,error:"No token found"}}catch{return{success:!1,error:"Failed to retrieve token"}}}}),n.ipcMain.handle("auth:remove-token",async()=>{try{return await f.deletePassword(y,S),{success:!0}}catch{try{return m.existsSync(p)&&m.unlinkSync(p),{success:!0}}catch{return{success:!1,error:"Failed to remove token"}}}}),n.ipcMain.handle("system:get-network-info",async()=>{try{const e=k.networkInterfaces();let s="127.0.0.1";for(const[a,u]of Object.entries(e))if(u){for(const c of u)if(c.family==="IPv4"&&!c.internal){s=c.address;break}}const t=await new Promise((a,u)=>{M.one((c,h)=>{c?u(c):a(h)})});return{success:!0,ipAddress:s,macAddress:t}}catch(e){return console.error("Failed to get network info:",e),{success:!1,error:e.message,ipAddress:"127.0.0.1",macAddress:"00:00:00:00:00:00"}}}),n.ipcMain.handle("screenshot:capture",async()=>{try{console.log("Starting screenshot capture...");const e=process.platform==="linux"&&process.env.WSL_DISTRO_NAME;return console.log("Detected WSL environment:",!!e),e?await o():await i()}catch(e){return console.error("Failed to capture screenshot:",e),{success:!1,error:e.message,permission:!1}}});async function o(){const{exec:e}=require("child_process"),{promisify:s}=require("util"),t=s(e);try{console.log("Using Windows PowerShell screenshot method for WSL");const a=Date.now(),u=`/tmp/screenshot_${a}.png`,c=`/tmp/screenshot_${a}.ps1`,h=`C:\\temp\\screenshot_${a}.png`,l=`C:\\temp\\screenshot_${a}.ps1`;await t("mkdir -p /tmp"),await t('powershell.exe -Command "New-Item -ItemType Directory -Force -Path C:\\temp"');const d=`Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing
$bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
$bitmap = New-Object System.Drawing.Bitmap $bounds.Width, $bounds.Height
$graphics = [System.Drawing.Graphics]::FromImage($bitmap)
$graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
$bitmap.Save('${h}', [System.Drawing.Imaging.ImageFormat]::Png)
$graphics.Dispose()
$bitmap.Dispose()
Write-Host "Screenshot saved to ${h}"`;console.log("Creating PowerShell script file..."),require("fs").writeFileSync(c,d,"utf8"),await t(`cp "${c}" "/mnt/c/temp/screenshot_${a}.ps1"`),console.log("Executing PowerShell script file..."),console.log("Script path:",l);const b=await t(`powershell.exe -ExecutionPolicy Bypass -File "${l}"`);console.log("PowerShell output:",b.stdout),console.log("Copying screenshot back to WSL..."),await t(`cp "/mnt/c/temp/screenshot_${a}.png" "${u}"`),console.log("Reading captured screenshot file...");const W=require("fs").readFileSync(u),v=W.toString("base64");return require("fs").unlinkSync(u),require("fs").unlinkSync(c),await t(`powershell.exe -Command "Remove-Item '${h}' -Force -ErrorAction SilentlyContinue"`),await t(`powershell.exe -Command "Remove-Item '${l}' -Force -ErrorAction SilentlyContinue"`),console.log("Screenshot captured successfully with PowerShell"),console.log("- Buffer size:",W.length,"bytes"),console.log("- Base64 length:",v.length),{success:!0,data:v,timestamp:new Date().toISOString(),permission:!0,source:"Windows PowerShell (WSL)",method:"powershell"}}catch(a){return console.error("PowerShell screenshot failed:",a),console.log("Falling back to Electron desktopCapturer..."),await i()}}async function i(){const{desktopCapturer:e}=await import("electron");console.log("Using Electron desktopCapturer method");const s=await e.getSources({types:["screen","window"],thumbnailSize:{width:1920,height:1080},fetchWindowIcons:!1});if(console.log("Found",s.length,"sources:"),s.forEach((l,d)=>{console.log(`Source ${d}:`,l.name,"id:",l.id)}),s.length===0)throw new Error("No displays found");let t=s.find(l=>l.name.includes("Entire screen")||l.name.includes("Screen"))||s[0];console.log("Using source:",t.name,"id:",t.id);const a=t.thumbnail,u=a.isEmpty();if(console.log("Thumbnail empty?",u,"size:",a.getSize()),u){console.log("Thumbnail is empty, trying alternative sources...");for(let l=1;l<s.length;l++){const d=s[l];if(console.log("Trying alternative source:",d.name),!d.thumbnail.isEmpty()){t=d,console.log("Found non-empty source:",t.name);break}}}const c=t.thumbnail.toPNG(),h=c.toString("base64");return console.log("Screenshot captured successfully with Electron"),console.log("- Source:",t.name),console.log("- Buffer size:",c.length,"bytes"),console.log("- Base64 length:",h.length),console.log("- Thumbnail size:",t.thumbnail.getSize()),{success:!0,data:h,timestamp:new Date().toISOString(),permission:!0,source:t.name,size:t.thumbnail.getSize(),method:"electron"}}n.ipcMain.handle("screenshot:start-schedule",async(e,s=5)=>{try{return this.screenshotInterval&&clearInterval(this.screenshotInterval),this.screenshotInterval=setInterval(()=>{var t;(t=this.mainWindow)==null||t.webContents.send("screenshot:trigger")},s*60*1e3),{success:!0}}catch(t){return console.error("Failed to start screenshot schedule:",t),{success:!1,error:t.message}}}),n.ipcMain.handle("screenshot:stop-schedule",async()=>{try{return this.screenshotInterval&&(clearInterval(this.screenshotInterval),this.screenshotInterval=null),{success:!0}}catch(e){return console.error("Failed to stop screenshot schedule:",e),{success:!1,error:e.message}}}),n.ipcMain.handle("fs:show-save-dialog",async(e,s)=>{try{return await n.dialog.showSaveDialog(this.mainWindow,s)}catch(t){return console.error("Failed to show save dialog:",t),{canceled:!0,error:t.message}}}),n.ipcMain.handle("shell:open-external",async(e,s)=>{try{return await n.shell.openExternal(s),{success:!0}}catch(t){return console.error("Failed to open external URL:",t),{success:!1,error:t.message}}}),n.ipcMain.handle("window:minimize",()=>{var e;(e=this.mainWindow)==null||e.minimize()}),n.ipcMain.handle("window:maximize",()=>{var e,s;(e=this.mainWindow)!=null&&e.isMaximized()?this.mainWindow.unmaximize():(s=this.mainWindow)==null||s.maximize()}),n.ipcMain.handle("window:close",()=>{var e;(e=this.mainWindow)==null||e.close()})}async initialize(){n.app.whenReady().then(()=>{this.setupIPC(),this.createWindow()}),n.app.on("window-all-closed",()=>{process.platform!=="darwin"&&n.app.quit()}),n.app.on("activate",async()=>{n.BrowserWindow.getAllWindows().length===0&&await this.createWindow()}),n.app.on("web-contents-created",(o,i)=>{i.on("new-window",e=>{e.preventDefault()}),i.setWindowOpenHandler(()=>({action:"deny"}))})}}const q=new O;q.initialize().catch(console.error);
